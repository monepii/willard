{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - WILLARD</title>
    <link rel="stylesheet" href="{% static 'CSS/styles.css' %}">
    <link rel="stylesheet" href="{% static 'checkout/CSS/styles.css' %}">
    <link rel="stylesheet" href="{% static 'CSS/styles_footer.css' %}">
    <link rel="stylesheet" href="{% static 'ferretetia/CSS/search.css' %}">
</head>
<body>
    {% include "ferretetia/auth.html" %}

    <!-- Header principal -->
    <header>
        <nav class="navbar">
            <div class="navbar-left">
                <div class="logo-container">
                    <a href="{% url 'ferretetia:index' %}">
                        <div class="logo-bg">WILLARD</div>
                    </a>
                </div>
            </div>
            <div class="navbar-center">
                <div class="search-container">
                    <input type="text" placeholder="Buscar Productos..." class="search-input">
                    <button class="search-btn">BUSCAR</button>
                </div>
            </div>
            <div class="navbar-right">
                <a href="{% url 'wishlist:wishlist' %}" class="nav-item">
                    <span class="icon">‚ô° WISHLIST</span>
                </a>
                <a href="{% url 'compare:compare' %}" class="nav-item">
                    <span class="icon">‚öñ COMPARAR</span>
                </a>
                <a href="{% url 'account:account' %}" class="nav-item">
                    <span class="icon">üë§ MI CUENTA</span>
                </a>
                <a href="{% url 'checkout:checkout' %}" class="nav-item active">
                    <span class="icon">üìã CHECKOUT</span>
                </a>
                <a href="{% url 'cart:cart' %}" class="nav-item cart">
                    <span class="icon">üõí CARRITO {% if cart_count > 0 %}({{ cart_count }}){% endif %}</span>
                </a>
            </div>
        </nav>
    </header>

    <nav class="bottom-nav">
        <div class="container">
            <div class="nav-menu">
             
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <h1>Checkout</h1>
            
            {% if user.is_authenticated %}
            <p>Finaliza tu compra de manera segura.</p>
            <div class="checkout-grid">
                <div class="checkout-form">
                    <h3>Informaci√≥n de Env√≠o</h3>
                    <form method="post" action="{% url 'checkout:process' %}" id="checkoutForm">
                        {% csrf_token %}
                        
                        <!-- Informaci√≥n personal -->
                        <div class="form-section">
                            <h4>Datos Personales</h4>
                            <input type="text" name="nombre_completo" placeholder="Nombre completo" 
                                   value="{% if perfil %}{{ perfil.nombre }} {{ perfil.apellido }}{% endif %}" required>
                            <input type="email" name="email" placeholder="Email" 
                                   value="{% if perfil %}{{ perfil.email }}{% elif user.email %}{{ user.email }}{% endif %}" required>
                            <input type="text" name="telefono" placeholder="Tel√©fono (opcional)" 
                                   value="{% if perfil %}{{ perfil.telefono }}{% endif %}">
                        </div>
                        
                        <!-- Selecci√≥n de direcci√≥n -->
                        <div class="form-section">
                            <h4>Direcci√≥n de Env√≠o</h4>
                            
                            {% if direcciones %}
                                <div class="address-section">
                                    <select name="direccion_existente" id="direccion-select" onchange="updateAddressPreview()" required>
                                        {% for direccion in direcciones %}
                                            <option value="{{ direccion.id }}" 
                                                    {% if direccion.es_principal %}selected{% endif %}
                                                    data-calle="{{ direccion.calle }}"
                                                    data-numero-ext="{{ direccion.numero_exterior }}"
                                                    data-numero-int="{{ direccion.numero_interior }}"
                                                    data-colonia="{{ direccion.colonia }}"
                                                    data-municipio="{{ direccion.municipio }}"
                                                    data-estado="{{ direccion.estado }}"
                                                    data-cp="{{ direccion.codigo_postal }}"
                                                    data-telefono="{{ direccion.telefono }}"
                                                    data-instrucciones="{{ direccion.instrucciones }}">
                                                {{ direccion.calle }} #{{ direccion.numero_exterior }}, {{ direccion.colonia }}
                                                {% if direccion.es_principal %} (Principal){% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    
                                    <div id="address-preview" class="address-preview">
                                        <!-- Aqu√≠ se mostrar√° la direcci√≥n seleccionada -->
                                    </div>
                                    
                                    <p class="address-note">
                                        <a href="{% url 'account:direcciones' %}" target="_blank">Gestionar mis direcciones</a>
                                    </p>
                                </div>
                            {% else %}
                                <div class="no-address-warning">
                                    <p><strong>‚ö†Ô∏è No tienes direcciones registradas</strong></p>
                                    <p>Para completar tu pedido, primero debes agregar una direcci√≥n de env√≠o.</p>
                                    <a href="{% url 'account:agregar_direccion' %}" class="btn-add-address">Agregar Direcci√≥n</a>
                                </div>
                            {% endif %}
                            
                            <!-- Campo oculto para indicar que siempre usa direcci√≥n existente -->
                            <input type="hidden" name="direccion_tipo" value="existente">
                        </div>
                        
                        <textarea name="notas" placeholder="Notas adicionales (opcional)" rows="3"></textarea>
                        <button type="submit" class="btn-primary">Confirmar Pedido</button>
                    </form>
                </div>
                <aside class="checkout-summary">
                    <h3>Resumen del Pedido</h3>
                    {% if items %}
                        <div class="order-count">
                            <small>{{ items|length }} producto{{ items|length|pluralize }}</small>
                        </div>
                        
                        <ul class="summary-items">
                        {% for item in items %}
                            <li class="summary-item">
                                <span class="item-name">
                                    {{ item.producto.nombre|truncatechars:25 }} 
                                    <small class="item-qty">x{{ item.cantidad }}</small>
                                </span>
                                <span class="item-price">${{ item.precio_total }}</span>
                            </li>
                        {% endfor %}
                        </ul>
                        
                        <div class="summary-totals">
                            <div>
                                <span>Subtotal</span>
                                <span>${{ subtotal }}</span>
                            </div>
                            {% if impuestos > 0 %}
                            <div>
                                <span>Impuestos</span>
                                <span>${{ impuestos }}</span>
                            </div>
                            {% endif %}
                            <div>
                                <span>Env√≠o</span>
                                {% if envio > 0 %}
                                    <span>${{ envio }}</span>
                                {% else %}
                                    <span class="free-shipping">Gratis</span>
                                {% endif %}
                            </div>
                            <div class="summary-total">
                                <span>Total</span>
                                <span>${{ total }}</span>
                            </div>
                        </div>
                        
                        <div class="summary-security">
                            <small class="security-note">
                                üîí Pago seguro
                            </small>
                        </div>
                    {% else %}
                        <div class="empty-cart">
                            <div class="empty-cart-icon">üõí</div>
                            <p>Carrito vac√≠o</p>
                        </div>
                    {% endif %}
                </aside>
            </div>
            {% else %}
            <p>Para finalizar tu compra de manera segura deber√°s <a style="color: blue " href="{% url 'account:login' %}">iniciar sesi√≥n</a> o <a style="color:blue" href="{%url 'account:register' %}">registrarte.</a></p>

            {% endif %}
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="footer">
        {% include "ferretetia/footer.html"%}
    </footer>
    
    <script>
        function updateAddressPreview() {
            const select = document.getElementById('direccion-select');
            const preview = document.getElementById('address-preview');
            
            if (!select || !preview) return;
            
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption) {
                const calle = selectedOption.dataset.calle || '';
                const numeroExt = selectedOption.dataset.numeroExt || '';
                const numeroInt = selectedOption.dataset.numeroInt || '';
                const colonia = selectedOption.dataset.colonia || '';
                const municipio = selectedOption.dataset.municipio || '';
                const estado = selectedOption.dataset.estado || '';
                const cp = selectedOption.dataset.cp || '';
                const telefono = selectedOption.dataset.telefono || '';
                const instrucciones = selectedOption.dataset.instrucciones || '';
                
                let addressHTML = `
                    <div class="selected-address">
                        <p><strong>Direcci√≥n:</strong> ${calle} #${numeroExt}`;
                        
                if (numeroInt) {
                    addressHTML += ` Int. ${numeroInt}`;
                }
                
                addressHTML += `</p>
                        <p><strong>Colonia:</strong> ${colonia}</p>
                        <p><strong>Ciudad:</strong> ${municipio}, ${estado}</p>
                        <p><strong>C√≥digo Postal:</strong> ${cp}</p>`;
                        
                if (telefono) {
                    addressHTML += `<p><strong>Tel√©fono:</strong> ${telefono}</p>`;
                }
                
                if (instrucciones) {
                    addressHTML += `<p><strong>Instrucciones:</strong> ${instrucciones}</p>`;
                }
                
                addressHTML += `</div>`;
                
                preview.innerHTML = addressHTML;
            }
        }
        
        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            updateAddressPreview();
        });
    </script>
</body>
</html>
